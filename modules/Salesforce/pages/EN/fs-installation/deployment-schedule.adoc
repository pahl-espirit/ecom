[[schedule]]
=== Deployment schedule
To transfer the content created in {fs} to the {ccloud} storage location, the reference project supplied has a schedule, which contains the actions specified below (see figure <<actions>>).
A description of the individual actions is provided in the subsequent sub-chapters.

More information on creating a schedule is available in the _{fsadmindoc_en}_.

[[actions]]
.Generation schedule actions
image::actions.png[]

// ************************************ Initializer ************************************
[[sfccinitializer]]
==== Initialize SFCC deployment
The first step is to initialize the deployment.
This involves setting up <<sfcc_content_cleanup,content cleanup>>.
While this is under way, a time stamp prior to the generation is created.
This time stamp is used by the <<sfcccleanup,cleanup action>> in the last step of the schedule to delete outdated assets and <<slot_configuration,slot configurations>>.
It is for this reason that the schedule contains the action `{sf} {ccloud} Initializer`:

.Schedule action
image::sfcc_initializer.png[]

[IMPORTANT]
====
To use <<sfcc_content_cleanup,content cleanup>>, the initialization must be the first action of the schedule.
Otherwise this can lead to inconsistencies in the data inventory.
====

// ************************************ Vollgenerierung ************************************
[[fdeployment]]
==== Content preparation - Full generation
To deploy the content that is relevant to {ccloud}, it must be determined from the project first.
This requires a full generation to be carried out, generating all the referenced media in the correct resolution.
The full generation also generates the XML collectors initialized in the <<project_settings,project settings>> and fills them on the basis of the xmlCollector calls in the templates.

The schedule therefore has the generation action `Content Preparation` in whose `*Properties*` the following options are activated (see figure <<content_preparation>>):

* `Perform FullGeneration`
* `Clear generation directory beforehand`
* `Generate Media in the generation directory`

The defined `Prefix for absolute paths` `/firstspirit` is required for the <<wddeployment,WebDAV deployment>> action.

[IMPORTANT]
====
It is only possible to use the <<wdmodule,WebDAV module>> in conjunction with the default URL creator.
To generate the path, the entry `Default URLs` is therefore selected, which is absolutely essential at this point.
====

The template sets for all the languages present in the project are also selected on the `*Extended*` tab page.
In addition, the variable `dwre_xmlGeneration` is added, which contains the value `false`.
This is set to the value `true` in the subsequent <<pdeployment,`XML Import File` actions>> and ensures that the XML files for the <<slot_configuration,slot configurations>> and assets are only created once the generation is complete.
The XML template in the project controls the process of generating the XML file.

[[content_preparation]]
.Content preparation action
image::content_preparation.png[]


// ************************************ Teilgenerierung ************************************
[[pdeployment]]
==== XML import file - Partial generations
{ccloud} expects all data that is transferred to it to be in the form of XML files.
For this reason, the information determined during the <<fdeployment,full generation>> must be read out of the XML collectors that are generated.
In this case, the information must instead be written to an XML file that has to be created each time.

For each XML collector initialized in the <<project_settings,project settings>>, the schedule provides another generation action.
In contrast to the <<fdeployment,`Content Preparation`>> action, these are, however, partial generations.
In their `*Properties*`, the option `Execute partial generation for following start nodes` is therefore activated.
As a starting point, one of the page references based on the XML template is used (see figure <<content_libary>>).

The variable `dwre_xmlGeneration`, which contains the value `true`, is also added to the `*Extended*` tab page for each of these actions.
Together with the start node selected in each case, this ensures that the selected page reference is not generated until this point in time.
This means that all the information required for creating the XML file will be available when this happens and it will not be possible for any gaps to appear.
The XML template in the project controls the process of generating the XML file.

[[content_libary]]
.Partial generation
image::content_libary.png[]

// ************************************ WebDAV-Deployment ************************************
[[wddeployment]]
==== WebDAV deployment
Next, the XML files generated by means of the <<pdeployment,partial generations>> must be transferred to {ccloud}.
They are published via a script action, for which the following parameters are defined in their `*Properties*`:

.Properties
image::wdparameter.png[]

url::
The `URL` specifies the host and the path on the WebDAV server.
It always has the following structure:
+
`\https://<SUBDOMAIN INSTANCE>.demandware.net/on/demandware.servlet/webdav/Sites/Impex/.../<PREFIX>/<SITE ID>`

[IMPORTANT]
====
The path points to the location where the XML file in question is expected to be during the import.
It must refer to an existing directory. +
Additionally, the prefix must be the same as the `Prefix for absolute paths` used in the <<fdeployment,full generation>>.
====

user::
A technical user who is authorized to use the WebDAV interface is required in order to transfer the data.
This user must have write permissions and must be specified by name here.
+
Further information about these rights can be found under https://documentation.b2c.commercecloud.salesforce.com/DOC2/topic/com.demandware.dochelp/Permissions/Creatingroles.html[menu:Administering Your Organization[Permissions, Users, and Roles>Roles and Permissions>Creating Roles and Assigning Permissions]] in the {sf} documentation.

password::
A password is also required for the user specified in the previous step.

[IMPORTANT]
====
The technical user is subject to the password conditions defined by {ccloud}, which require the password to be changed at least every quarter.
The parameter value must be changed each time this is carried out.
====

mediaurl::
The media folder generated during the generation process, and its content, must be transferred to a separate directory so that {ccloud} can perform the import.
This directory is defined using the parameter `mediaurl`.
The `mediaurl` always has the following structure:
+
`\https://<SUBDOMAIN INSTANCE>.demandware.net/on/demandware.servlet/webdav/Sites/Libraries/<SITE ID|LIBRARY ID>/default/<PREFIX>`

[IMPORTANT]
====
The `mediaurl` must refer to an existing directory. +
Furthermore, as with the `url`, the prefix must be the same as the `Prefix for absolute paths` used in the <<fdeployment,full generation>>.
====

[IMPORTANT]
====
If a private library is being used, it is necessary to specify the site ID instead of the library ID in the path.
====

srcprefixdir::
If only one particular directory is transferred to {ccloud}, it can be specified in relation to the root node of the generation directory using the optional parameter `srcprefixdir`.
If the parameter is not defined, or no value is saved for it, the entire generation directory will be transferred.

purge::
This parameter is optional and may only have the value `true` or `false`.
If `true` is set, all the files and directories under the specified `URL` will be deleted before the transfer starts.
If the parameter is set to `false` or no value at all, all the existing files and directories under the specified `URL` will be retained.
New data will either be added or, in the case of existing data, overwritten.

[IMPORTANT]
====
The WebDAV deployment must not be executed in the event of an error.
====


// ************************************ Cloud Importer ************************************
==== Trigger SFCC import job schedule
Following the publication of the created XML files via <<wddeployment,WebDAV deployment>>, the <<sfcc_job_schedules,created job schedule>> is executed.
In {sf}, the job schedule triggers the import of the generated content and <<slot_configuration,slot configurations>> into {ccloud}.
The _{modulname}_ module provides the `{sf} {ccloud} Importer` schedule action for this purpose:

[[sfcc_task]]
.Schedule action
image::sfcc_task.png[]

The action loads a configuration dialog, in which two parameters must be defined in addition to a freely assignable name.

[[sfcc_task_config]]
.Schedule action parameters
image::import_schedule_task.png[]

Import Job ID::
This field contains the ID of the <<sfcc_job_schedules,created job schedule>>.

Timeout::
The value in this field displays the time span in seconds, in which the status of the job schedule will be queried every second.
If the job schedule has not completed in the specified time span, this schedule action is indicated as having an error.
The default value is 10 seconds.

[IMPORTANT]
====
As the `*{sf} {ccloud} Importer*` requires a successful <<wddeployment,WebDAV deployment>>, this too must not be executed in the event of an error.
====

// ************************************ Cleanup ************************************
[[sfcccleanup]]
==== Salesforce Commerce Cloud Cleanup
Once the <<sfcc_job_schedules,created job schedule>> has been executed, content cleanup is executed.
All outdated assets and <<slot_configuration,slot configurations>> are queried by the <<ocapisettings,OC API>> and then deleted.
The _{modulname}_ module provides the `{sf} {ccloud} Cleanup` schedule action for this purpose:

[[sfcc_task]]
.Schedule action
image::sfcc_cleanup.png[]

In addition to a freely assignable name for this schedule action, the associated configuration dialog contains the following parameters:

[[sfcc_task_config]]
.Schedule action parameters
image::cleanup_schedule_task.png[]

Use different site::
Content cleanup uses a {ccloud} site to find the content assets and slot configurations to be deleted.
The checkbox `Use different site` allows the use of content cleanup for a site other than the <<project-app-config-base-url, configured>> site.

[[cleanupSiteId]]
Site Id::
If the `Use different site` checkbox is active, the {ccloud} site to be used for content cleanup must be specified in this field.

menu:Content asset cleanup[Enabled]::
This checkbox allows to enable/disable the content cleanup of assets.

Library Id::
The ID of the Content Library from that Content Assets are deleted must be entered in this field.
In the case of a private library, the library ID corresponds to the site ID.

[[additionalRefinements]]
Additional refinement(s)::
In this field, attribute names and values can be specified for further filtering of the content assets to be deleted.
The specification must have the following form:
+
[source,xml]
----
ATTRIBUTE_NAME=ATTRIBUTE_VALUE [; ATTRIBUTE_NAME=ATTRIBUTE_VALUE] ...
----
+
The attribute values can contain the following parameters:
+
[options="header", cols="25,25" ]
|=======
|Parameter | Replacement by
|&#36;&#123;projectId&#125; | The ID of the generated {fs} project
|&#36;&#123;projectName&#125; | The name of the generated {fs} project
|=======

[NOTE]
====
The specified attributes must exist as custom attributes in the {ccloud} and have been filled with values via the <<generation,{fs} generation>> before the filtering described here can be used.
====

menu:Slot configuration cleanup[Enabled]::
This checkbox allows the de-/activation of the content cleanup from <<slot_configuration,Slot configurations>>.

Filter query::
This field is used to filter the <<slot_configuration,slot configurations>> to be deleted.
A filter is specified as a https://documentation.b2c.commercecloud.salesforce.com/DOC2/topic/com.demandware.dochelp/OCAPI/current/data/Documents/Query.html[query document] in JSON format.
Within the query, the parameters of the field <<additionalRefinements,Additional refinement(s)>> can be used, as the following example of a
https://documentation.b2c.commercecloud.salesforce.com/DOC2/topic/com.demandware.dochelp/OCAPI/current/data/Documents/TextQuery.html[TextQuery] illustrates:
+
[source,json,subs="attributes"]
----
"text_query": {
    "fields": ["c_fsProjectId"],
    "search_phrase": "${{projectIdRaw}}"
}
----
+
If the `Filter query` field remains empty, the _{modulname}_ module uses a https://documentation.b2c.commercecloud.salesforce.com/DOC2/topic/com.demandware.dochelp/OCAPI/current/data/Documents/MatchAllQuery.html[MatchAllQuery],
whereby the <<slot_configuration,slot configurations>> to be deleted are not further filtered.

[IMPORTANT]
====
To avoid inconsistencies in the database or data loss, the action `*Salesforce {ccloud} Cleanup*` must be the last action of the schedule.
For the same reason, <<sfcc_content_cleanup,content cleanup>> requires that this action only performs full generations.
Furthermore, replication within the {ccloud} is not recommended during the execution of the cleanup.
====

[IMPORTANT]
====
Since the `*Salesforce {ccloud} Cleanup*` requires a successful execution of the <<sfcc_job_schedules,job schedules>> and thus the import of the content, it must not be executed in the event of an error.
====
